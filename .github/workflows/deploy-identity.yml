# ==========================================================================
# Enterprise Azure Landing Zone - Identity Resources Deployment
# ==========================================================================
# PROMPT ENGINEERING GUIDANCE:
# This workflow deploys core identity resources for a cloud-only enterprise landing zone:
# - Azure AD Domain Services (managed domain service)
# - Key Vault for identity-related secrets with private endpoints
# - Log Analytics workspace for identity monitoring
# - User-assigned managed identities for workload authentication
# - Private DNS integration with connectivity subscription
#
# CLOUD-ONLY CONSIDERATIONS:
# - No AD Connect or hybrid identity components
# - Pure Azure AD/Entra ID authentication model
# - PaaS services protected with private endpoints
# - Network integration with hub-spoke model
#
# ERROR PREVENTION TIPS:
# 1. Always use ${{ }} syntax when referencing environment variables in conditionals
# 2. Ensure all job dependencies are correctly specified
# 3. Verify secret names match what's configured in GitHub repository settings
# 4. Validate Bicep templates locally before committing

name: Deploy Identity Resources

on:
  push:
    branches:
      - main
    paths:
      - 'identity/**'
      - '.github/workflows/deploy-identity.yml'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - nonproduction
          - development
      region:
        description: 'Azure region for deployment'
        required: true
        default: 'eastus2'
        type: string
      deployAadds:
        description: 'Deploy Azure AD Domain Services'
        required: true
        default: 'true'
        type: boolean

permissions:
  id-token: write  # Required for OIDC federation
  contents: read   # Required to read repo files

# ==========================================================================
# ENVIRONMENT VARIABLES - CRITICAL SECRET CONFIGURATION
# ==========================================================================
# PROMPT GUIDANCE:
# - Identity subscription should be separate from other workloads
# - IDENTITY_SUBSCRIPTION_ID must exist as a repository secret
# - CONNECTIVITY_SUBSCRIPTION_ID needed for DNS integration
# - The service principal requires appropriate RBAC in the identity subscription
# - Consider using Azure PIM for Eligible roles rather than permanent assignment
# ==========================================================================
env:
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  IDENTITY_SUBSCRIPTION_ID: ${{ secrets.IDENTITY_SUBSCRIPTION_ID }}
  CONNECTIVITY_SUBSCRIPTION_ID: ${{ secrets.CONNECTIVITY_SUBSCRIPTION_ID }}
  RESOURCE_GROUP_NAME: rg-identity
  LOCATION: ${{ github.event.inputs.region || 'eastus2' }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}
  DEPLOY_AADDS: ${{ github.event.inputs.deployAadds || 'true' }}

jobs:
  # ==========================================================================
  # VERIFY PREREQUISITES JOB
  # ==========================================================================
  # PROMPT GUIDANCE:
  # - Validation before deployment prevents downstream failures
  # - Check Azure connectivity and permissions
  # - Verify connectivity to hub network for DNS integration
  # - Ensure proper Entra ID permissions for domain services
  # ==========================================================================
  verify-prerequisites:
    name: Verify Prerequisites
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check required secrets
        run: |
          # Verify tenant ID
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "::error::AZURE_TENANT_ID secret is not set"
            exit 1
          fi
          
          # Verify client ID
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
            echo "::error::AZURE_CLIENT_ID secret is not set"
            exit 1
          fi
          
          # Verify subscription ID
          if [ -z "${{ secrets.IDENTITY_SUBSCRIPTION_ID }}" ]; then
            echo "::error::IDENTITY_SUBSCRIPTION_ID secret is not set"
            exit 1
          fi
          
          # Verify connectivity subscription ID (needed for DNS integration)
          if [ -z "${{ secrets.CONNECTIVITY_SUBSCRIPTION_ID }}" ]; then
            echo "::warning::CONNECTIVITY_SUBSCRIPTION_ID secret is not set. DNS integration may be limited."
          fi
          
          echo "All required secrets are configured."
          
          # Determine subscription to use
          SUB_ID="${{ secrets.IDENTITY_SUBSCRIPTION_ID }}"
          echo "Using subscription ID: ${SUB_ID:0:8}..."
          echo "SUBSCRIPTION_ID=$SUB_ID" >> $GITHUB_ENV

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.IDENTITY_SUBSCRIPTION_ID }}
      
      - name: Verify Azure connectivity and permissions
        run: |
          echo "Verifying Azure permissions..."
          
          # Try to list resource groups to verify permissions
          if ! az group list --query "[].name" -o tsv &>/dev/null; then
            echo "::error::Unable to list resource groups. Check service principal permissions."
            exit 1
          fi
          
          echo "Azure connectivity verified successfully."
      
      - name: Check for Identity VNet
        run: |
          # Look for existing identity VNet
          echo "Checking for existing identity VNet..."
          
          IDENTITY_VNET=$(az network vnet list \
            --query "[?contains(name, 'identity')].name" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$IDENTITY_VNET" ]; then
            echo "Found existing identity VNet: $IDENTITY_VNET"
          else
            echo "No existing identity VNet found. A new one will be deployed."
          fi

  # ==========================================================================
  # DEPLOY IDENTITY INFRASTRUCTURE JOB
  # ==========================================================================
  # PROMPT GUIDANCE:
  # - Infrastructure must be deployed before identity services
  # - Network integration with hub VNet is critical
  # - Resource group implementation follows enterprise naming standards
  # - Consistent tagging strategy enables better governance
  # - Use parameters files for consistent configuration across environments
  # ==========================================================================
  deploy-identity-infrastructure:
    name: Deploy Identity Infrastructure
    needs: verify-prerequisites
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.IDENTITY_SUBSCRIPTION_ID }}
      
      - name: Create resource group
        run: |
          echo "Creating resource group ${{ env.RESOURCE_GROUP_NAME }} in ${{ env.LOCATION }}..."
          
          az group create \
            --name ${{ env.RESOURCE_GROUP_NAME }} \
            --location ${{ env.LOCATION }} \
            --tags environment=${{ env.ENVIRONMENT }} workload=identity deployedBy=GitHub
          
          echo "Resource group created or confirmed."
      
      - name: Deploy identity network
        id: deploy_network
        run: |
          echo "Deploying identity network infrastructure..."
          
          # Check if identity network template exists
          if [ ! -f "identity/network/identity-network.bicep" ]; then
            echo "::warning::identity-network.bicep not found. Creating minimal network template."
            
            # Create a minimal identity network Bicep file if it doesn't exist
            mkdir -p identity/network
            cat > identity/network/identity-network.bicep << 'EOF'
            // Identity Network for cloud-only deployment
            @description('Azure region for all resources')
            param location string = resourceGroup().location

            @description('Environment name')
            param environment string = 'production'

            @description('Address space for the identity virtual network')
            param addressPrefix string = '10.2.0.0/16'

            @description('Name of the identity virtual network')
            param vnetName string = 'vnet-identity'

            @description('Tags to apply to all resources')
            param tags object = {
              environment: environment
              workload: 'identity'
              deployment: 'bicep'
            }

            // Define subnets
            var subnets = [
              {
                name: 'snet-identity-services'
                properties: {
                  addressPrefix: '10.2.0.0/24'
                  privateEndpointNetworkPolicies: 'Disabled'
                }
              }
              {
                name: 'snet-domain-services'
                properties: {
                  addressPrefix: '10.2.1.0/24'
                }
              }
              {
                name: 'snet-private-endpoints'
                properties: {
                  addressPrefix: '10.2.2.0/24'
                  privateEndpointNetworkPolicies: 'Disabled'
                }
              }
            ]

            // Create Virtual Network
            resource identityVNet 'Microsoft.Network/virtualNetworks@2023-04-01' = {
              name: vnetName
              location: location
              tags: tags
              properties: {
                addressSpace: {
                  addressPrefixes: [
                    addressPrefix
                  ]
                }
                subnets: subnets
              }
            }

            // Create Network Security Group for identity services subnet
            resource nsgIdentityServices 'Microsoft.Network/networkSecurityGroups@2023-04-01' = {
              name: 'nsg-${subnets[0].name}'
              location: location
              tags: tags
              properties: {
                securityRules: [
                  {
                    name: 'AllowHttpsInbound'
                    properties: {
                      priority: 100
                      direction: 'Inbound'
                      access: 'Allow'
                      protocol: 'Tcp'
                      sourceAddressPrefix: '*'
                      sourcePortRange: '*'
                      destinationAddressPrefix: '*'
                      destinationPortRange: '443'
                    }
                  }
                ]
              }
            }

            // Output the VNet ID for use in other deployments
            output vnetId string = identityVNet.id
            output vnetName string = identityVNet.name
            EOF
          fi
          
          # Find parameter file
          PARAM_PATH=""
          PARAM_PATHS=(
            "identity/network/parameters/identity-network.parameters.json"
            "identity/network/parameters/identity-network-${{ env.ENVIRONMENT }}.parameters.json"
            "identity/parameters/identity-network.parameters.json"
          )
          
          for path in "${PARAM_PATHS[@]}"; do
            if [ -f "$path" ]; then
              echo "Using parameter file: $path"
              PARAM_PATH="$path"
              break
            fi
          done
          
          # Deploy network
          if [ -n "$PARAM_PATH" ]; then
            az deployment group create \
              --name "identity-network-$(date +%Y%m%d%H%M%S)" \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --template-file identity/network/identity-network.bicep \
              --parameters @$PARAM_PATH \
              --parameters environment=${{ env.ENVIRONMENT }} location=${{ env.LOCATION }}
          else
            az deployment group create \
              --name "identity-network-$(date +%Y%m%d%H%M%S)" \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --template-file identity/network/identity-network.bicep \
              --parameters environment=${{ env.ENVIRONMENT }} location=${{ env.LOCATION }}
          fi
          
          # Get the VNet ID
          VNET_ID=$(az network vnet show \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --name "vnet-identity" \
            --query id -o tsv)
          
          echo "VNET_ID=$VNET_ID" >> $GITHUB_OUTPUT
          echo "Identity network deployed successfully."

      - name: Deploy Log Analytics workspace
        run: |
          echo "Deploying Log Analytics workspace..."
          
          # Check if Log Analytics template exists
          if [ ! -f "identity/monitoring/log-analytics.bicep" ]; then
            echo "::warning::log-analytics.bicep not found. Creating minimal template."
            
            # Create a minimal Log Analytics Bicep file if it doesn't exist
            mkdir -p identity/monitoring
            cat > identity/monitoring/log-analytics.bicep << 'EOF'
            // Log Analytics for identity monitoring
            @description('Azure region for all resources')
            param location string = resourceGroup().location

            @description('Environment name')
            param environment string = 'production'

            @description('Log Analytics workspace name')
            param workspaceName string = 'law-identity'

            @description('Log retention in days')
            param retentionInDays int = 30

            @description('Tags to apply to all resources')
            param tags object = {
              environment: environment
              workload: 'identity'
              deployment: 'bicep'
            }

            // Create Log Analytics workspace
            resource logAnalytics 'Microsoft.OperationalInsights/workspaces@2022-10-01' = {
              name: workspaceName
              location: location
              tags: tags
              properties: {
                sku: {
                  name: 'PerGB2018'
                }
                retentionInDays: retentionInDays
                features: {
                  enableLogAccessUsingOnlyResourcePermissions: true
                }
              }
            }

            // Output the workspace ID and primary key for use in diagnostics
            output workspaceId string = logAnalytics.id
            output workspaceName string = logAnalytics.name
            EOF
          fi
          
          # Deploy Log Analytics workspace
          az deployment group create \
            --name "log-analytics-$(date +%Y%m%d%H%M%S)" \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --template-file identity/monitoring/log-analytics.bicep \
            --parameters environment=${{ env.ENVIRONMENT }} location=${{ env.LOCATION }}
          
          echo "Log Analytics workspace deployed successfully."
      
      # Set up VNet peering if connectivity subscription is available
      - name: Set up VNet peering to hub
        if: ${{ env.CONNECTIVITY_SUBSCRIPTION_ID != '' }}  # Proper syntax for env var in conditional
        run: |
          echo "Setting up VNet peering to hub network..."
          
          # Login to connectivity subscription to get hub VNet ID
          az login --service-principal \
            --username ${{ env.AZURE_CLIENT_ID }} \
            --tenant ${{ env.AZURE_TENANT_ID }} \
            --federated-token "$(cat $ACTIONS_ID_TOKEN_REQUEST_TOKEN)" \
            --allow-no-subscriptions
            
          az account set --subscription ${{ env.CONNECTIVITY_SUBSCRIPTION_ID }}
          
          # Get hub VNet ID
          HUB_VNET_ID=$(az network vnet list \
            --query "[?contains(name, 'hub')].id" -o tsv 2>/dev/null || echo "")
          
          if [ -z "$HUB_VNET_ID" ]; then
            echo "::warning::Hub VNet not found in connectivity subscription. Skipping peering."
            exit 0
          fi
          
          HUB_VNET_NAME=$(echo $HUB_VNET_ID | awk -F '/' '{print $NF}')
          HUB_RG_NAME=$(echo $HUB_VNET_ID | awk -F '/' '{print $5}')
          
          echo "Found hub VNet: $HUB_VNET_NAME in $HUB_RG_NAME"
          
          # Switch back to identity subscription
          az account set --subscription ${{ env.IDENTITY_SUBSCRIPTION_ID }}
          
          # Get identity VNet ID
          IDENTITY_VNET_ID=$(az network vnet show \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --name "vnet-identity" \
            --query id -o tsv)
            
          IDENTITY_VNET_NAME="vnet-identity"
          
          # Create peering from identity to hub
          echo "Creating identity to hub peering..."
          az network vnet peering create \
            --name "peering-identity-to-hub" \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --vnet-name "$IDENTITY_VNET_NAME" \
            --remote-vnet "$HUB_VNET_ID" \
            --allow-vnet-access \
            --allow-forwarded-traffic \
            --use-remote-gateways
            
          # Switch to connectivity subscription for hub to identity peering
          az account set --subscription ${{ env.CONNECTIVITY_SUBSCRIPTION_ID }}
          
          # Create peering from hub to identity
          echo "Creating hub to identity peering..."
          az network vnet peering create \
            --name "peering-hub-to-identity" \
            --resource-group "$HUB_RG_NAME" \
            --vnet-name "$HUB_VNET_NAME" \
            --remote-vnet "$IDENTITY_VNET_ID" \
            --allow-vnet-access \
            --allow-forwarded-traffic \
            --allow-gateway-transit
            
          echo "VNet peering set up successfully."
          
          # Switch back to identity subscription
          az account set --subscription ${{ env.IDENTITY_SUBSCRIPTION_ID }}

  # ==========================================================================
  # DEPLOY KEY VAULT JOB
  # ==========================================================================
  # PROMPT GUIDANCE:
  # - Key Vault with private endpoint for secure secret storage
  # - Access policies align with least-privilege principles
  # - RBAC or Access Policy mode based on enterprise requirements
  # - HSM protection for production secrets
  # - Private DNS integration for internal resolution
  # ==========================================================================
  deploy-key-vault:
    name: Deploy Key Vault
    needs: deploy-identity-infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.IDENTITY_SUBSCRIPTION_ID }}
      
      - name: Deploy Key Vault
        run: |
          echo "Deploying Key Vault for identity secrets..."
          
          # Check if Key Vault template exists
          if [ ! -f "identity/key-vault/key-vault.bicep" ]; then
            echo "::warning::key-vault.bicep not found. Creating secure Key Vault template."
            
            # Create a Key Vault Bicep file if it doesn't exist
            mkdir -p identity/key-vault
            cat > identity/key-vault/key-vault.bicep << 'EOF'
            // Key Vault with private endpoint for identity resources
            @description('Azure region for all resources')
            param location string = resourceGroup().location

            @description('Environment name')
            param environment string = 'production'

            @description('Key Vault name')
            param keyVaultName string = 'kv-identity-${uniqueString(resourceGroup().id)}'

            @description('Azure AD tenant ID')
            param tenantId string

            @description('ID of the identity VNet')
            param vnetId string

            @description('Name of the subnet for private endpoints')
            param privateEndpointSubnetName string = 'snet-private-endpoints'

            @description('SKU name for Key Vault')
            param skuName string = 'premium'

            @description('Tags to apply to all resources')
            param tags object = {
              environment: environment
              workload: 'identity'
              deployment: 'bicep'
            }

            // Reference the subnet for private endpoint
            resource subnet 'Microsoft.Network/virtualNetworks/subnets@2023-04-01' existing = {
              name: '${split(vnetId, '/')[8]}/${privateEndpointSubnetName}'
            }

            // Create Key Vault with enhanced security
            resource keyVault 'Microsoft.KeyVault/vaults@2023-02-01' = {
              name: keyVaultName
              location: location
              tags: tags
              properties: {
                sku: {
                  family: 'A'
                  name: skuName
                }
                tenantId: tenantId
                enabledForDeployment: true
                enabledForDiskEncryption: true
                enabledForTemplateDeployment: true
                enableRbacAuthorization: true
                enableSoftDelete: true
                softDeleteRetentionInDays: 90
                publicNetworkAccess: 'Disabled'
                networkAcls: {
                  bypass: 'AzureServices'
                  defaultAction: 'Deny'
                }
              }
            }

            // Create private endpoint for Key Vault
            resource privateEndpoint 'Microsoft.Network/privateEndpoints@2023-04-01' = {
              name: 'pe-${keyVaultName}'
              location: location
              tags: tags
              properties: {
                subnet: {
                  id: subnet.id
                }
                privateLinkServiceConnections: [
                  {
                    name: 'connection-to-${keyVaultName}'
                    properties: {
                      privateLinkServiceId: keyVault.id
                      groupIds: [
                        'vault'
                      ]
                    }
                  }
                ]
              }
            }

            // Create private DNS zone group
            resource privateDnsZoneGroup 'Microsoft.Network/privateEndpoints/privateDnsZoneGroups@2023-04-01' = {
              name: '${privateEndpoint.name}/default'
              properties: {
                privateDnsZoneConfigs: [
                  {
                    name: 'private-dns-config'
                    properties: {
                      privateDnsZoneId: resourceId(subscription().subscriptionId, resourceGroup().name, 'Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')
                    }
                  }
                ]
              }
            }

            // Output Key Vault resource ID
            output keyVaultId string = keyVault.id
            output keyVaultName string = keyVault.name
            EOF
          fi
          
          # Get the identity VNet ID
          VNET_ID=$(az network vnet show \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --name "vnet-identity" \
            --query id -o tsv)
          
          # Create private DNS zone for Key Vault if it doesn't exist
          echo "Creating private DNS zone for Key Vault..."
          if ! az network private-dns zone show \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --name "privatelink.vaultcore.azure.net" &>/dev/null; then
            
            az network private-dns zone create \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --name "privatelink.vaultcore.azure.net"
              
            # Link private DNS zone to VNet
            az network private-dns link vnet create \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --zone-name "privatelink.vaultcore.azure.net" \
              --name "link-to-identity-vnet" \
              --virtual-network $VNET_ID \
              --registration-enabled false
          fi
          
          # Deploy Key Vault
          echo "Deploying Key Vault..."
          az deployment group create \
            --name "key-vault-$(date +%Y%m%d%H%M%S)" \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --template-file identity/key-vault/key-vault.bicep \
            --parameters environment=${{ env.ENVIRONMENT }} \
                         location=${{ env.LOCATION }} \
                         tenantId=${{ env.AZURE_TENANT_ID }} \
                         vnetId=$VNET_ID
          
          echo "Key Vault deployed successfully."

  # ==========================================================================
  # DEPLOY AZURE AD DOMAIN SERVICES JOB
  # ==========================================================================
  # PROMPT GUIDANCE:
  # - Azure AD DS provides managed domain services for a cloud-only environment
  # - Only deployed if specifically requested (costly service)
  # - Requires careful network configuration and security groups
  # - SKU selection based on directory size and performance needs
  # - CRITICAL FIX: Always use ${{ }} syntax for environment variables in conditionals
  # ==========================================================================
  deploy-aadds:
    name: Deploy Azure AD Domain Services
    needs: [deploy-identity-infrastructure, deploy-key-vault]
    runs-on: ubuntu-latest
    # FIX: Added ${{ }} around env variable reference in conditional
    if: ${{ env.DEPLOY_AADDS == 'true' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.IDENTITY_SUBSCRIPTION_ID }}
      
      - name: Create AADDS template
        run: |
          echo "Creating Azure AD Domain Services template..."
          
          mkdir -p identity/aadds
          cat > identity/aadds/aadds.bicep << 'EOF'
          // Azure AD Domain Services for cloud-only environment
          @description('Azure region for all resources')
          param location string = resourceGroup().location

          @description('Environment name')
          param environment string = 'production'

          @description('Domain name for AADDS')
          param domainName string = 'aadds.contoso.com'

          @description('SKU for AADDS')
          @allowed(['Standard', 'Enterprise', 'Premium'])
          param sku string = 'Standard'

          @description('ID of the identity VNet')
          param vnetId string

          @description('Name of the subnet for AADDS')
          param aaddsSubnetName string = 'snet-domain-services'

          @description('Tags to apply to all resources')
          param tags object = {
            environment: environment
            workload: 'identity'
            deployment: 'bicep'
          }

          // Extract subscription ID and resource group name from VNet ID
          var vnetSubscriptionId = split(vnetId, '/')[2]
          var vnetResourceGroup = split(vnetId, '/')[4]
          var vnetName = split(vnetId, '/')[8]

          // Reference the subnet for AADDS
          resource subnet 'Microsoft.Network/virtualNetworks/subnets@2023-04-01' existing = {
            name: '${vnetName}/${aaddsSubnetName}'
            scope: resourceGroup(vnetSubscriptionId, vnetResourceGroup)
          }

          // Create a Network Security Group for AADDS
          resource aaddsNsg 'Microsoft.Network/networkSecurityGroups@2023-04-01' = {
            name: 'nsg-aadds'
            location: location
            tags: tags
            properties: {
              securityRules: [
                {
                  name: 'AllowRD'
                  properties: {
                    priority: 201
                    direction: 'Inbound'
                    access: 'Allow'
                    protocol: 'Tcp'
                    sourceAddressPrefix: '*'
                    sourcePortRange: '*'
                    destinationAddressPrefix: '*'
                    destinationPortRange: '3389'
                  }
                }
                {
                  name: 'AllowLDAPS'
                  properties: {
                    priority: 202
                    direction: 'Inbound'
                    access: 'Allow'
                    protocol: 'Tcp'
                    sourceAddressPrefix: '*'
                    sourcePortRange: '*'
                    destinationAddressPrefix: '*'
                    destinationPortRange: '636'
                  }
                }
                {
                  name: 'AllowLDAP'
                  properties: {
                    priority: 203
                    direction: 'Inbound'
                    access: 'Allow'
                    protocol: 'Tcp'
                    sourceAddressPrefix: '*'
                    sourcePortRange: '*'
                    destinationAddressPrefix: '*'
                    destinationPortRange: '389'
                  }
                }
                {
                  name: 'AllowSMTP'
                  properties: {
                    priority: 204
                    direction: 'Inbound'
                    access: 'Allow'
                    protocol: 'Tcp'
                    sourceAddressPrefix: '*'
                    sourcePortRange: '*'
                    destinationAddressPrefix: '*'
                    destinationPortRange: '25'
                  }
                }
                {
                  name: 'AllowKerberos'
                  properties: {
                    priority: 205
                    direction: 'Inbound'
                    access: 'Allow'
                    protocol: 'Tcp'
                    sourceAddressPrefix: '*'
                    sourcePortRange: '*'
                    destinationAddressPrefix: '*'
                    destinationPortRange: '88'
                  }
                }
                {
                  name: 'AllowUDP'
                  properties: {
                    priority: 206
                    direction: 'Inbound'
                    access: 'Allow'
                    protocol: 'Udp'
                    sourceAddressPrefix: '*'
                    sourcePortRange: '*'
                    destinationAddressPrefix: '*'
                    destinationPortRange: '*'
                  }
                }
              ]
            }
          }

          // Associate NSG with the subnet
          resource subnetWithNsg 'Microsoft.Network/virtualNetworks/subnets@2023-04-01' = {
            name: '${vnetName}/${aaddsSubnetName}'
            properties: {
              addressPrefix: subnet.properties.addressPrefix
              networkSecurityGroup: {
                id: aaddsNsg.id
              }
            }
          }

          // Deploy Azure AD Domain Services
          resource aadds 'Microsoft.AAD/domainServices@2022-12-01' = {
            name: 'aadds-${environment}'
            location: location
            tags: tags
            properties: {
              domainName: domainName
              domainConfigurationType: 'FullySynced'
              sku: sku
              replicaSets: [
                {
                  subnetId: subnet.id
                  location: location
                }
              ]
            }
            dependsOn: [
              subnetWithNsg
            ]
          }

          // Output AADDS resource ID
          output aaddsId string = aadds.id
          output aaddsName string = aadds.name
          EOF
          
          echo "Azure AD Domain Services template created."
      
      - name: Deploy Azure AD Domain Services
        run: |
          echo "Deploying Azure AD Domain Services..."
          
          # Get the VNet ID
          VNET_ID=$(az network vnet show \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --name "vnet-identity" \
            --query id -o tsv)
            
          # Deploy AADDS
          az deployment group create \
            --name "aadds-$(date +%Y%m%d%H%M%S)" \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --template-file identity/aadds/aadds.bicep \
            --parameters environment=${{ env.ENVIRONMENT }} \
                         location=${{ env.LOCATION }} \
                         vnetId=$VNET_ID \
                         domainName="aadds.${{ env.AZURE_TENANT_ID }}.onmicrosoft.com"
          
          echo "Azure AD Domain Services deployment initiated."
          echo "Note: AADDS deployment can take 1-2 hours to complete."

  # ==========================================================================
  # DEPLOY MANAGED IDENTITIES JOB
  # ==========================================================================
  # PROMPT GUIDANCE:
  # - Managed identities for workload authentication
  # - Use user-assigned identities for better control and lifecycle management
  # - Add appropriate RBAC assignments based on workload needs
  # - Configure diagnostics for improved security monitoring
  # ==========================================================================
  deploy-managed-identities:
    name: Deploy Managed Identities
    needs: deploy-identity-infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.IDENTITY_SUBSCRIPTION_ID }}
      
      - name: Create managed identities template
        run: |
          echo "Creating managed identities template..."
          
          mkdir -p identity/managed-identity
          cat > identity/managed-identity/managed-identities.bicep << 'EOF'
          // User-assigned managed identities for workloads
          @description('Azure region for all resources')
          param location string = resourceGroup().location

          @description('Environment name')
          param environment string = 'production'

          @description('Tags to apply to all resources')
          param tags object = {
            environment: environment
            workload: 'identity'
            deployment: 'bicep'
          }

          // Create user-assigned managed identities
          resource appManagedIdentity 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
            name: 'id-app-services'
            location: location
            tags: tags
          }

          resource dataWorkloadIdentity 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
            name: 'id-data-workloads'
            location: location
            tags: tags
          }

          resource automationIdentity 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
            name: 'id-automation'
            location: location
            tags: tags
          }

          // Outputs for reference in other deployments
          output appIdentityId string = appManagedIdentity.id
          output appIdentityPrincipalId string = appManagedIdentity.properties.principalId
          
          output dataWorkloadIdentityId string = dataWorkloadIdentity.id
          output dataWorkloadPrincipalId string = dataWorkloadIdentity.properties.principalId
          
          output automationIdentityId string = automationIdentity.id
          output automationPrincipalId string = automationIdentity.properties.principalId
          EOF
          
          echo "Managed identities template created."
      
      - name: Deploy managed identities
        run: |
          echo "Deploying managed identities..."
          
          # Deploy managed identities
          az deployment group create \
            --name "managed-identities-$(date +%Y%m%d%H%M%S)" \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --template-file identity/managed-identity/managed-identities.bicep \
            --parameters environment=${{ env.ENVIRONMENT }} location=${{ env.LOCATION }}
          
          echo "Managed identities deployed successfully."

  # ==========================================================================
  # VERIFY IDENTITY RESOURCES JOB
  # ==========================================================================
  # PROMPT GUIDANCE:
  # - Validation ensures all resources deployed successfully
  # - Documentation shows what was deployed and where
  # - Helps in troubleshooting deployment issues
  # - Provides clear next steps for users of the identity services
  # - Always verify both resource existence and configuration
  # ==========================================================================
  verify-resources:
    name: Verify Identity Resources
    needs: [deploy-key-vault, deploy-managed-identities]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.IDENTITY_SUBSCRIPTION_ID }}
      
      - name: List and verify deployed resources
        run: |
          echo "Verifying deployed identity resources..."
          
          # List all resources in the resource group
          echo "Resources in ${{ env.RESOURCE_GROUP_NAME }}:"
          az resource list \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --output table
          
          # Check for key components
          echo "Checking for key identity components..."
          
          # Check for VNet
          if az network vnet show \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --name "vnet-identity" &>/dev/null; then
            echo "✅ Identity VNet verified"
            
            # List subnets
            echo "Subnets in identity VNet:"
            az network vnet subnet list \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --vnet-name "vnet-identity" \
              --query "[].{Name:name, Prefix:addressPrefix}" \
              --output table
          else
            echo "❌ Identity VNet not found"
          fi
          
          # Check for Key Vault
          KV_NAME=$(az keyvault list \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --query "[0].name" -o tsv 2>/dev/null || echo "")
            
          if [ -n "$KV_NAME" ]; then
            echo "✅ Key Vault verified: $KV_NAME"
          else
            echo "❌ Key Vault not found"
          fi
          
          # Check for Log Analytics
          if az monitor log-analytics workspace list \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --query "[0].name" -o tsv &>/dev/null; then
            echo "✅ Log Analytics workspace verified"
          else
            echo "❌ Log Analytics workspace not found"
          fi
          
          # Check for Managed Identities
          IDENTITIES=$(az identity list \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --query "[].name" -o tsv 2>/dev/null || echo "")
            
          if [ -n "$IDENTITIES" ]; then
            echo "✅ Managed identities verified:"
            echo "$IDENTITIES"
          else
            echo "❌ Managed identities not found"
          fi
          
          # Check for AADDS if deployed
          if [ "${{ env.DEPLOY_AADDS }}" == "true" ]; then
            if az resource list \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --resource-type "Microsoft.AAD/domainServices" \
              --query "[0].name" -o tsv &>/dev/null; then
              echo "✅ Azure AD Domain Services deployment initiated"
              echo "Note: Full provisioning may take 1-2 hours to complete"
            else
              echo "❌ Azure AD Domain Services not found"
            fi
          fi
          
          # Generate summary report
          cat << EOF > $GITHUB_STEP_SUMMARY
          # Identity Resources Deployment Results
          
          **Resource Group:** ${{ env.RESOURCE_GROUP_NAME }}
          **Environment:** ${{ env.ENVIRONMENT }}
          **Region:** ${{ env.LOCATION }}
          
          ## Deployed Resources
          
          | Resource Type | Count |
          |--------------|-------|
          EOF
          
          # Add resource counts to summary
          RESOURCES=$(az resource list --resource-group ${{ env.RESOURCE_GROUP_NAME }} --query "[].type" -o tsv 2>/dev/null | sort | uniq -c || echo "")
          if [ -z "$RESOURCES" ]; then
            echo "| No resources found | 0 |" >> $GITHUB_STEP_SUMMARY
          else
            while read -r line; do
              if [ -n "$line" ]; then
                COUNT=$(echo $line | awk '{print $1}')
                TYPE=$(echo $line | awk '{print $2}')
                echo "| $TYPE | $COUNT |" >> $GITHUB_STEP_SUMMARY
              fi
            done <<< "$RESOURCES"
          fi
          
          # Add final instructions
          cat << EOF >> $GITHUB_STEP_SUMMARY
          
          ## Next Steps for Cloud-Only Identity Environment
          
          1. **Network Configuration**
             - Ensure all spoke networks are peered with the identity network
             - Configure NSGs for appropriate access control
          
          2. **Azure AD Domain Services** (if deployed)
             - Complete domain configuration in Azure portal
             - Set up administrative users and groups
             - Configure LDAPS certificates if needed
          
          3. **Key Vault Access**
             - Grant appropriate access to applications and users
             - Store secrets, keys, and certificates
          
          4. **Managed Identities**
             - Assign appropriate RBAC roles to managed identities
             - Use managed identities in your applications
          
          ## Security Considerations
          
          - Use Private Endpoints for all PaaS services
          - Implement Azure Policy for governance
          - Set up Azure Security Center for threat protection
          - Configure Azure Monitor alerts for identity-related events
          
          ## Viewing Resources
          
          In the Azure portal:
          1. Go to **Resource groups**
          2. Select **${{ env.RESOURCE_GROUP_NAME }}**
          3. View the identity resources in the content pane
          
          For Azure AD DS status, navigate to the Azure AD Domain Services blade.
          EOF