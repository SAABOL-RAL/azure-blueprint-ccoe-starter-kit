name: Deploy Identity Resources

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy-identity.yml'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - nonproduction
          - development
      region:
        description: 'Azure region for deployment'
        required: true
        default: 'eastus2'
        type: string
      deployAadds:
        description: 'Deploy Azure AD Domain Services'
        required: true
        default: 'true'
        type: boolean

permissions:
  id-token: write  # Required for OIDC federation
  contents: read   # Required to read repo files

env:
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  IDENTITY_SUBSCRIPTION_ID: ${{ secrets.IDENTITY_SUBSCRIPTION_ID }}
  RESOURCE_GROUP_NAME: rg-identity
  LOCATION: ${{ github.event.inputs.region || 'eastus2' }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}
  DEPLOY_AADDS: ${{ github.event.inputs.deployAadds || 'true' }}

jobs:
  # ==================================================================================
  # VERIFY PREREQUISITES
  # ==================================================================================
  verify-prerequisites:
    name: Verify Prerequisites
    runs-on: ubuntu-latest
    outputs:
      tenant_id: ${{ steps.output_params.outputs.tenant_id }}
      deploy_aadds: ${{ steps.output_params.outputs.deploy_aadds }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check required secrets
        run: |
          # Verify tenant ID
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "::error::AZURE_TENANT_ID secret is not set"
            exit 1
          fi
          
          # Verify client ID
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
            echo "::error::AZURE_CLIENT_ID secret is not set"
            exit 1
          fi
          
          # Verify subscription ID
          if [ -z "${{ secrets.IDENTITY_SUBSCRIPTION_ID }}" ]; then
            echo "::error::IDENTITY_SUBSCRIPTION_ID secret is not set"
            exit 1
          fi
          
          echo "All required secrets are configured."

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.IDENTITY_SUBSCRIPTION_ID }}
      
      - name: Verify Azure connectivity
        run: |
          echo "Verifying Azure permissions..."
          
          # Try to list resource groups to verify permissions
          if ! az group list --query "[].name" -o tsv &>/dev/null; then
            echo "::error::Unable to list resource groups. Check service principal permissions."
            exit 1
          fi
          
          echo "Azure connectivity verified successfully."
          
      - name: Set output parameters
        id: output_params
        run: |
          echo "tenant_id=${{ env.AZURE_TENANT_ID }}" >> $GITHUB_OUTPUT
          echo "deploy_aadds=${{ env.DEPLOY_AADDS }}" >> $GITHUB_OUTPUT

  # ==================================================================================
  # DEPLOY IDENTITY INFRASTRUCTURE
  # ==================================================================================
  deploy-identity-infrastructure:
    name: Deploy Identity Infrastructure
    needs: verify-prerequisites
    runs-on: ubuntu-latest
    outputs:
      vnet_id: ${{ steps.vnet_output.outputs.vnet_id }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.IDENTITY_SUBSCRIPTION_ID }}
      
      - name: Create resource group
        run: |
          echo "Creating resource group ${{ env.RESOURCE_GROUP_NAME }} in ${{ env.LOCATION }}..."
          
          az group create \
            --name ${{ env.RESOURCE_GROUP_NAME }} \
            --location ${{ env.LOCATION }} \
            --tags environment=${{ env.ENVIRONMENT }} workload=identity deployedBy=GitHub
          
          echo "Resource group created or confirmed."
      
      - name: Create Bicep module files
        run: |
          echo "Creating necessary Bicep module files..."
          
          # Create modules directory
          mkdir -p modules
          
          # Create identity-network.bicep file
          echo "Creating identity-network.bicep..."
          cat > modules/identity-network.bicep << 'EOF'
          // Identity Network for cloud-only deployment
          @description('Azure region for all resources')
          param location string = resourceGroup().location

          @description('Environment name')
          param environment string = 'production'

          @description('Address space for the identity virtual network')
          param addressPrefix string = '10.2.0.0/16'

          @description('Name of the identity virtual network')
          param vnetName string = 'vnet-identity'

          @description('Tags to apply to all resources')
          param tags object = {
            environment: environment
            workload: 'identity'
            deployment: 'bicep'
          }

          // Define subnets
          var subnets = [
            {
              name: 'snet-identity-services'
              properties: {
                addressPrefix: '10.2.0.0/24'
                privateEndpointNetworkPolicies: 'Disabled'
              }
            }
            {
              name: 'snet-domain-services'
              properties: {
                addressPrefix: '10.2.1.0/24'
              }
            }
            {
              name: 'snet-private-endpoints'
              properties: {
                addressPrefix: '10.2.2.0/24'
                privateEndpointNetworkPolicies: 'Disabled'
              }
            }
          ]

          // Create Virtual Network
          resource identityVNet 'Microsoft.Network/virtualNetworks@2023-04-01' = {
            name: vnetName
            location: location
            tags: tags
            properties: {
              addressSpace: {
                addressPrefixes: [
                  addressPrefix
                ]
              }
              subnets: subnets
            }
          }

          // Output the VNet ID for use in other deployments
          output vnetId string = identityVNet.id
          output vnetName string = identityVNet.name
          EOF
          
          # Create key-vault.bicep file
          echo "Creating key-vault.bicep..."
          cat > modules/key-vault.bicep << 'EOF'
          // Key Vault with private endpoint for identity resources
          @description('Azure region for all resources')
          param location string = resourceGroup().location

          @description('Environment name')
          param environment string = 'production'

          @description('Key Vault name')
          param keyVaultName string = 'kv-identity-${uniqueString(resourceGroup().id)}'

          @description('Azure AD tenant ID')
          param tenantId string

          @description('ID of the identity VNet')
          param vnetId string

          @description('Name of the subnet for private endpoints')
          param privateEndpointSubnetName string = 'snet-private-endpoints'

          @description('SKU name for Key Vault')
          param skuName string = 'premium'

          @description('Tags to apply to all resources')
          param tags object = {
            environment: environment
            workload: 'identity'
            deployment: 'bicep'
          }

          // Reference the subnet for private endpoint
          resource subnet 'Microsoft.Network/virtualNetworks/subnets@2023-04-01' existing = {
            name: '${split(vnetId, '/')[8]}/${privateEndpointSubnetName}'
          }

          // Create Key Vault with enhanced security
          resource keyVault 'Microsoft.KeyVault/vaults@2023-02-01' = {
            name: keyVaultName
            location: location
            tags: tags
            properties: {
              sku: {
                family: 'A'
                name: skuName
              }
              tenantId: tenantId
              enabledForDeployment: true
              enabledForDiskEncryption: true
              enabledForTemplateDeployment: true
              enableRbacAuthorization: true
              enableSoftDelete: true
              softDeleteRetentionInDays: 90
              publicNetworkAccess: 'Disabled'
              networkAcls: {
                bypass: 'AzureServices'
                defaultAction: 'Deny'
              }
            }
          }

          // Create private endpoint for Key Vault
          resource privateEndpoint 'Microsoft.Network/privateEndpoints@2023-04-01' = {
            name: 'pe-${keyVaultName}'
            location: location
            tags: tags
            properties: {
              subnet: {
                id: subnet.id
              }
              privateLinkServiceConnections: [
                {
                  name: 'connection-to-${keyVaultName}'
                  properties: {
                    privateLinkServiceId: keyVault.id
                    groupIds: [
                      'vault'
                    ]
                  }
                }
              ]
            }
          }

          // Output Key Vault resource ID
          output keyVaultId string = keyVault.id
          output keyVaultName string = keyVault.name
          EOF
          
          # Create managed-identities.bicep file
          echo "Creating managed-identities.bicep..."
          cat > modules/managed-identities.bicep << 'EOF'
          // User-assigned managed identities for workloads
          @description('Azure region for all resources')
          param location string = resourceGroup().location

          @description('Environment name')
          param environment string = 'production'

          @description('Tags to apply to all resources')
          param tags object = {
            environment: environment
            workload: 'identity'
            deployment: 'bicep'
          }

          // Create user-assigned managed identities
          resource appManagedIdentity 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
            name: 'id-app-services'
            location: location
            tags: tags
          }

          resource dataWorkloadIdentity 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
            name: 'id-data-workloads'
            location: location
            tags: tags
          }

          resource automationIdentity 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
            name: 'id-automation'
            location: location
            tags: tags
          }

          // Outputs for reference in other deployments
          output appIdentityId string = appManagedIdentity.id
          output appIdentityPrincipalId string = appManagedIdentity.properties.principalId

          output dataWorkloadIdentityId string = dataWorkloadIdentity.id
          output dataWorkloadPrincipalId string = dataWorkloadIdentity.properties.principalId

          output automationIdentityId string = automationIdentity.id
          output automationPrincipalId string = automationIdentity.properties.principalId
          EOF
          
          # Create aadds.bicep file
          echo "Creating aadds.bicep..."
          cat > modules/aadds.bicep << 'EOF'
          // Azure AD Domain Services for cloud-only environment
          @description('Azure region for all resources')
          param location string = resourceGroup().location

          @description('Environment name')
          param environment string = 'production'

          @description('Domain name for AADDS')
          param domainName string = 'aadds.contoso.com'

          @description('SKU for AADDS')
          @allowed(['Standard', 'Enterprise', 'Premium'])
          param sku string = 'Standard'

          @description('ID of the identity VNet')
          param vnetId string

          @description('Name of the subnet for AADDS')
          param aaddsSubnetName string = 'snet-domain-services'

          @description('Tags to apply to all resources')
          param tags object = {
            environment: environment
            workload: 'identity'
            deployment: 'bicep'
          }

          // Extract VNet name from VNet ID
          var vnetName = split(vnetId, '/')[8]

          // Reference the subnet for AADDS
          resource subnet 'Microsoft.Network/virtualNetworks/subnets@2023-04-01' existing = {
            name: '${vnetName}/${aaddsSubnetName}'
          }

          // Create a Network Security Group for AADDS
          resource aaddsNsg 'Microsoft.Network/networkSecurityGroups@2023-04-01' = {
            name: 'nsg-aadds'
            location: location
            tags: tags
            properties: {
              securityRules: [
                {
                  name: 'AllowLDAPS'
                  properties: {
                    priority: 201
                    direction: 'Inbound'
                    access: 'Allow'
                    protocol: 'Tcp'
                    sourceAddressPrefix: '*'
                    sourcePortRange: '*'
                    destinationAddressPrefix: '*'
                    destinationPortRange: '636'
                  }
                }
                {
                  name: 'AllowLDAP'
                  properties: {
                    priority: 202
                    direction: 'Inbound'
                    access: 'Allow'
                    protocol: 'Tcp'
                    sourceAddressPrefix: '*'
                    sourcePortRange: '*'
                    destinationAddressPrefix: '*'
                    destinationPortRange: '389'
                  }
                }
                {
                  name: 'AllowKerberos'
                  properties: {
                    priority: 203
                    direction: 'Inbound'
                    access: 'Allow'
                    protocol: 'Tcp'
                    sourceAddressPrefix: '*'
                    sourcePortRange: '*'
                    destinationAddressPrefix: '*'
                    destinationPortRange: '88'
                  }
                }
              ]
            }
          }

          // Deploy Azure AD Domain Services
          resource aadds 'Microsoft.AAD/domainServices@2022-12-01' = {
            name: 'aadds-${environment}'
            location: location
            tags: tags
            properties: {
              domainName: domainName
              domainConfigurationType: 'FullySynced'
              sku: sku
              replicaSets: [
                {
                  subnetId: subnet.id
                  location: location
                }
              ]
            }
          }

          // Output AADDS resource ID
          output aaddsId string = aadds.id
          output aaddsName string = aadds.name
          EOF
          
          echo "Bicep module files created successfully."
          ls -la modules/
      
      - name: Deploy identity network
        id: deploy_network
        run: |
          echo "Deploying identity network infrastructure..."
          
          # Deploy using the created Bicep file
          az deployment group create \
            --name "identity-network-$(date +%Y%m%d%H%M%S)" \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --template-file modules/identity-network.bicep \
            --parameters environment=${{ env.ENVIRONMENT }} location=${{ env.LOCATION }}
      
      - name: Get VNet ID
        id: vnet_output
        run: |
          # Get the VNet ID
          VNET_ID=$(az network vnet show \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --name "vnet-identity" \
            --query id -o tsv)
          
          echo "vnet_id=$VNET_ID" >> $GITHUB_OUTPUT
          echo "Identity network deployed successfully."

  # ==================================================================================
  # DEPLOY KEY VAULT
  # ==================================================================================
  deploy-key-vault:
    name: Deploy Key Vault
    needs: deploy-identity-infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.IDENTITY_SUBSCRIPTION_ID }}
      
      - name: Recreate Bicep module files
        run: |
          # Recreate modules directory and Bicep files
          # (We need to recreate them in each job since GitHub Actions doesn't preserve files between jobs)
          mkdir -p modules
          
          cat > modules/key-vault.bicep << 'EOF'
          // Key Vault with private endpoint for identity resources
          @description('Azure region for all resources')
          param location string = resourceGroup().location

          @description('Environment name')
          param environment string = 'production'

          @description('Key Vault name')
          param keyVaultName string = 'kv-identity-${uniqueString(resourceGroup().id)}'

          @description('Azure AD tenant ID')
          param tenantId string

          @description('ID of the identity VNet')
          param vnetId string

          @description('Name of the subnet for private endpoints')
          param privateEndpointSubnetName string = 'snet-private-endpoints'

          @description('SKU name for Key Vault')
          param skuName string = 'premium'

          @description('Tags to apply to all resources')
          param tags object = {
            environment: environment
            workload: 'identity'
            deployment: 'bicep'
          }

          // Reference the subnet for private endpoint
          resource subnet 'Microsoft.Network/virtualNetworks/subnets@2023-04-01' existing = {
            name: '${split(vnetId, '/')[8]}/${privateEndpointSubnetName}'
          }

          // Create Key Vault with enhanced security
          resource keyVault 'Microsoft.KeyVault/vaults@2023-02-01' = {
            name: keyVaultName
            location: location
            tags: tags
            properties: {
              sku: {
                family: 'A'
                name: skuName
              }
              tenantId: tenantId
              enabledForDeployment: true
              enabledForDiskEncryption: true
              enabledForTemplateDeployment: true
              enableRbacAuthorization: true
              enableSoftDelete: true
              softDeleteRetentionInDays: 90
              publicNetworkAccess: 'Disabled'
              networkAcls: {
                bypass: 'AzureServices'
                defaultAction: 'Deny'
              }
            }
          }

          // Create private endpoint for Key Vault
          resource privateEndpoint 'Microsoft.Network/privateEndpoints@2023-04-01' = {
            name: 'pe-${keyVaultName}'
            location: location
            tags: tags
            properties: {
              subnet: {
                id: subnet.id
              }
              privateLinkServiceConnections: [
                {
                  name: 'connection-to-${keyVaultName}'
                  properties: {
                    privateLinkServiceId: keyVault.id
                    groupIds: [
                      'vault'
                    ]
                  }
                }
              ]
            }
          }

          // Output Key Vault resource ID
          output keyVaultId string = keyVault.id
          output keyVaultName string = keyVault.name
          EOF
      
      - name: Deploy Key Vault
        run: |
          echo "Deploying Key Vault for identity secrets..."
          
          # Get the identity VNet ID
          VNET_ID=$(az network vnet show \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --name "vnet-identity" \
            --query id -o tsv)
          
          # Deploy Key Vault using module
          az deployment group create \
            --name "key-vault-$(date +%Y%m%d%H%M%S)" \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --template-file modules/key-vault.bicep \
            --parameters environment=${{ env.ENVIRONMENT }} \
                         location=${{ env.LOCATION }} \
                         tenantId=${{ env.AZURE_TENANT_ID }} \
                         vnetId=$VNET_ID
          
          echo "Key Vault deployed successfully."

# The rest of the jobs follow the same pattern - recreate the bicep files in each job before use