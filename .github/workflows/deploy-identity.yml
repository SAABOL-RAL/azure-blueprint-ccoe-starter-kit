# ==========================================================================
# Enterprise Azure Landing Zone - Identity Resources Deployment
# ==========================================================================
# PROMPT ENGINEERING GUIDANCE:
# This workflow provisions core identity resources for a cloud-only enterprise landing zone:
# - Azure AD Domain Services (managed domain service)
# - Key Vault for identity-related secrets with private endpoints
# - Log Analytics workspace for identity monitoring
# - User-assigned managed identities for workload authentication
# - Private DNS integration with connectivity subscription
#
# WORKFLOW STRUCTURE & JOB DEPENDENCIES:
# 1. CRITICAL: At least one job must have NO dependencies (no "needs" parameter)
#    - This serves as the entry point for the workflow
#    - GitHub requires this to avoid circular dependencies
# 2. Job execution order is determined by the "needs" parameter
#    - Use "needs: [job1, job2]" to specify jobs that must complete first
#    - Jobs without dependencies will run first and in parallel
# 3. Linear flow example: Job A → Job B → Job C → Job D
#    - Job A: no "needs" parameter (workflow entry point)
#    - Job B: needs: [job-a]
#    - Job C: needs: [job-b]
#    - Job D: needs: [job-c]

name: Provision Identity

on:
  push:
    branches:
      - main
    paths:
      - 'identity/**'
      - '.github/workflows/deploy-identity.yml'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - nonproduction
          - development
      region:
        description: 'Azure region for deployment'
        required: true
        default: 'eastus2'
        type: string
      deployAadds:
        description: 'Deploy Azure AD Domain Services'
        required: true
        default: 'true'
        type: boolean

permissions:
  id-token: write  # Required for OIDC federation
  contents: read   # Required to read repo files

env:
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  IDENTITY_SUBSCRIPTION_ID: ${{ secrets.IDENTITY_SUBSCRIPTION_ID }}
  CONNECTIVITY_SUBSCRIPTION_ID: ${{ secrets.CONNECTIVITY_SUBSCRIPTION_ID }}
  RESOURCE_GROUP_NAME: rg-identity
  LOCATION: ${{ github.event.inputs.region || 'eastus2' }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}
  DEPLOY_AADDS: ${{ github.event.inputs.deployAadds || 'true' }}

jobs:
  # ==========================================================================
  # VERIFY PREREQUISITES JOB - WORKFLOW ENTRY POINT (NO DEPENDENCIES)
  # ==========================================================================
  # PROMPT GUIDANCE:
  # - This job has NO "needs" parameter - it will run first as the entry point
  # - Every GitHub Actions workflow MUST have at least one job without dependencies
  # - Validation before deployment prevents downstream failures
  # - Check Azure connectivity and permissions early to fail fast
  # ==========================================================================
  verify-prerequisites:
    name: Verify Prerequisites
    # NO "needs" parameter here - this is the workflow entry point!
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check required secrets
        run: |
          # Verify tenant ID
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "::error::AZURE_TENANT_ID secret is not set"
            exit 1
          fi
          
          # Verify client ID
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
            echo "::error::AZURE_CLIENT_ID secret is not set"
            exit 1
          fi
          
          # Verify subscription ID
          if [ -z "${{ secrets.IDENTITY_SUBSCRIPTION_ID }}" ]; then
            echo "::error::IDENTITY_SUBSCRIPTION_ID secret is not set"
            exit 1
          fi
          
          # Verify connectivity subscription ID (needed for DNS integration)
          if [ -z "${{ secrets.CONNECTIVITY_SUBSCRIPTION_ID }}" ]; then
            echo "::warning::CONNECTIVITY_SUBSCRIPTION_ID secret is not set. DNS integration may be limited."
          fi
          
          echo "All required secrets are configured."

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.IDENTITY_SUBSCRIPTION_ID }}
      
      - name: Verify Azure connectivity and permissions
        run: |
          echo "Verifying Azure permissions..."
          
          # Try to list resource groups to verify permissions
          if ! az group list --query "[].name" -o tsv &>/dev/null; then
            echo "::error::Unable to list resource groups. Check service principal permissions."
            exit 1
          fi
          
          echo "Azure connectivity verified successfully."

  # ==========================================================================
  # DEPLOY IDENTITY INFRASTRUCTURE JOB
  # ==========================================================================
  # PROMPT GUIDANCE:
  # - This job depends on verify-prerequisites job completion
  # - Network integration with hub VNet is critical
  # - Resource group implementation follows enterprise naming standards
  # - Consistent tagging strategy enables better governance
  # ==========================================================================
  deploy-identity-infrastructure:
    name: Deploy Identity Infrastructure
    needs: verify-prerequisites  # This job depends on verify-prerequisites
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.IDENTITY_SUBSCRIPTION_ID }}
      
      - name: Create resource group
        run: |
          echo "Creating resource group ${{ env.RESOURCE_GROUP_NAME }} in ${{ env.LOCATION }}..."
          
          az group create \
            --name ${{ env.RESOURCE_GROUP_NAME }} \
            --location ${{ env.LOCATION }} \
            --tags environment=${{ env.ENVIRONMENT }} workload=identity deployedBy=GitHub
          
          echo "Resource group created or confirmed."
      
      - name: Deploy identity network
        id: deploy_network
        run: |
          echo "Deploying identity network infrastructure..."
          
          # Check if identity network template exists
          if [ ! -f "identity/network/identity-network.bicep" ]; then
            echo "::warning::identity-network.bicep not found. Creating minimal network template."
            
            # Create a minimal identity network Bicep file if it doesn't exist
            mkdir -p identity/network
            cat > identity/network/identity-network.bicep << 'EOF'
            // Identity Network for cloud-only deployment
            @description('Azure region for all resources')
            param location string = resourceGroup().location

            @description('Environment name')
            param environment string = 'production'

            @description('Address space for the identity virtual network')
            param addressPrefix string = '10.2.0.0/16'

            @description('Name of the identity virtual network')
            param vnetName string = 'vnet-identity'

            @description('Tags to apply to all resources')
            param tags object = {
              environment: environment
              workload: 'identity'
              deployment: 'bicep'
            }

            // Define subnets
            var subnets = [
              {
                name: 'snet-identity-services'
                properties: {
                  addressPrefix: '10.2.0.0/24'
                  privateEndpointNetworkPolicies: 'Disabled'
                }
              }
              {
                name: 'snet-domain-services'
                properties: {
                  addressPrefix: '10.2.1.0/24'
                }
              }
              {
                name: 'snet-private-endpoints'
                properties: {
                  addressPrefix: '10.2.2.0/24'
                  privateEndpointNetworkPolicies: 'Disabled'
                }
              }
            ]

            // Create Virtual Network
            resource identityVNet 'Microsoft.Network/virtualNetworks@2023-04-01' = {
              name: vnetName
              location: location
              tags: tags
              properties: {
                addressSpace: {
                  addressPrefixes: [
                    addressPrefix
                  ]
                }
                subnets: subnets
              }
            }

            // Output the VNet ID for use in other deployments
            output vnetId string = identityVNet.id
            output vnetName string = identityVNet.name
            EOF
          fi
          
          # Deploy network
          az deployment group create \
            --name "identity-network-$(date +%Y%m%d%H%M%S)" \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --template-file identity/network/identity-network.bicep \
            --parameters environment=${{ env.ENVIRONMENT }} location=${{ env.LOCATION }}
          
          # Get the VNet ID
          VNET_ID=$(az network vnet show \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --name "vnet-identity" \
            --query id -o tsv)
          
          echo "VNET_ID=$VNET_ID" >> $GITHUB_OUTPUT
          echo "Identity network deployed successfully."

  # ==========================================================================
  # DEPLOY KEY VAULT JOB
  # ==========================================================================
  # PROMPT GUIDANCE:
  # - Only runs after identity infrastructure is deployed
  # - Key Vault with private endpoint for secure secret storage
  # - Access policies align with least-privilege principles
  # - HSM protection for production secrets
  # ==========================================================================
  deploy-key-vault:
    name: Deploy Key Vault
    needs: deploy-identity-infrastructure  # This job depends on deploy-identity-infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.IDENTITY_SUBSCRIPTION_ID }}
      
      - name: Deploy Key Vault
        run: |
          echo "Deploying Key Vault for identity secrets..."
          
          # Get the identity VNet ID
          VNET_ID=$(az network vnet show \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --name "vnet-identity" \
            --query id -o tsv)
          
          # Create private DNS zone for Key Vault if it doesn't exist
          echo "Creating private DNS zone for Key Vault..."
          if ! az network private-dns zone show \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --name "privatelink.vaultcore.azure.net" &>/dev/null; then
            
            az network private-dns zone create \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --name "privatelink.vaultcore.azure.net"
              
            # Link private DNS zone to VNet
            az network private-dns link vnet create \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --zone-name "privatelink.vaultcore.azure.net" \
              --name "link-to-identity-vnet" \
              --virtual-network $VNET_ID \
              --registration-enabled false
          fi
          
          # Deploy Key Vault
          echo "Deploying Key Vault..."
          az deployment group create \
            --name "key-vault-$(date +%Y%m%d%H%M%S)" \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --template-file identity/key-vault/key-vault.bicep \
            --parameters environment=${{ env.ENVIRONMENT }} \
                         location=${{ env.LOCATION }} \
                         tenantId=${{ env.AZURE_TENANT_ID }} \
                         vnetId=$VNET_ID
          
          echo "Key Vault deployed successfully."

  # ==========================================================================
  # DEPLOY AZURE AD DOMAIN SERVICES JOB
  # ==========================================================================
  # PROMPT GUIDANCE:
  # - Azure AD DS provides managed domain services for a cloud-only environment
  # - Only deployed if specifically requested (costly service)
  # - Requires careful network configuration and security groups
  # - Job-level conditionals use simplified syntax without ${{ }}
  # ==========================================================================
  deploy-aadds:
    name: Deploy Azure AD Domain Services
    needs: deploy-identity-infrastructure  # Only depends on infrastructure, not Key Vault
    runs-on: ubuntu-latest
    # Simplified syntax for job-level conditional - no curly braces
    if: env.DEPLOY_AADDS == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.IDENTITY_SUBSCRIPTION_ID }}
      
      - name: Deploy Azure AD Domain Services
        run: |
          echo "Deploying Azure AD Domain Services..."
          
          # Get the VNet ID
          VNET_ID=$(az network vnet show \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --name "vnet-identity" \
            --query id -o tsv)
            
          # Deploy AADDS
          az deployment group create \
            --name "aadds-$(date +%Y%m%d%H%M%S)" \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --template-file identity/aadds/aadds.bicep \
            --parameters environment=${{ env.ENVIRONMENT }} \
                         location=${{ env.LOCATION }} \
                         vnetId=$VNET_ID \
                         domainName="aadds.${{ env.AZURE_TENANT_ID }}.onmicrosoft.com"
          
          echo "Azure AD Domain Services deployment initiated."
          echo "Note: AADDS deployment can take 1-2 hours to complete."

  # ==========================================================================
  # DEPLOY MANAGED IDENTITIES JOB
  # ==========================================================================
  # PROMPT GUIDANCE:
  # - This job only depends on identity infrastructure, can run in parallel with other jobs
  # - Managed identities for workload authentication
  # - User-assigned identities for better control and lifecycle management
  # ==========================================================================
  deploy-managed-identities:
    name: Deploy Managed Identities
    needs: deploy-identity-infrastructure  # Only depends on infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.IDENTITY_SUBSCRIPTION_ID }}
      
      - name: Deploy managed identities
        run: |
          echo "Deploying managed identities..."
          
          # Deploy managed identities
          az deployment group create \
            --name "managed-identities-$(date +%Y%m%d%H%M%S)" \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --template-file identity/managed-identity/managed-identities.bicep \
            --parameters environment=${{ env.ENVIRONMENT }} location=${{ env.LOCATION }}
          
          echo "Managed identities deployed successfully."

  # ==========================================================================
  # VERIFY IDENTITY RESOURCES JOB
  # ==========================================================================
  # PROMPT GUIDANCE:
  # - Runs after Key Vault and Managed Identities are deployed
  # - Does NOT depend on AADDS job since that's optional and takes a long time
  # - Validation ensures all resources deployed successfully
  # - Provides clear deployment summary and next steps
  # ==========================================================================
  verify-identity-resources:
    name: Verify Identity Resources
    needs: [deploy-key-vault, deploy-managed-identities]  # Depends on these jobs specifically
    if: always()  # Run even if some jobs fail, to provide status
    runs-on: ubuntu-latest
    
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.IDENTITY_SUBSCRIPTION_ID }}
      
      - name: List and verify deployed resources
        run: |
          echo "Verifying deployed identity resources..."
          
          # List all resources in the resource group
          echo "Resources in ${{ env.RESOURCE_GROUP_NAME }}:"
          az resource list \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --output table
          
          # Check for key components
          echo "Checking for key identity components..."
          
          # Check for VNet
          if az network vnet show \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --name "vnet-identity" &>/dev/null; then
            echo "✅ Identity VNet verified"
          else
            echo "❌ Identity VNet not found"
          fi
          
          # Check for Key Vault
          KV_NAME=$(az keyvault list \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --query "[0].name" -o tsv 2>/dev/null || echo "")
            
          if [ -n "$KV_NAME" ]; then
            echo "✅ Key Vault verified: $KV_NAME"
          else
            echo "❌ Key Vault not found"
          fi
          
          # Check for Managed Identities
          IDENTITIES=$(az identity list \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --query "[].name" -o tsv 2>/dev/null || echo "")
            
          if [ -n "$IDENTITIES" ]; then
            echo "✅ Managed identities verified:"
            echo "$IDENTITIES"
          else
            echo "❌ Managed identities not found"
          fi
          
          # Check for AADDS if deployed
          if [ "${{ env.DEPLOY_AADDS }}" == "true" ]; then
            if az resource list \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --resource-type "Microsoft.AAD/domainServices" \
              --query "[0].name" -o tsv &>/dev/null; then
              echo "✅ Azure AD Domain Services deployment initiated"
              echo "Note: Full provisioning may take 1-2 hours to complete"
            else
              echo "❓ Azure AD Domain Services not found yet (deployment may still be in progress)"
            fi
          fi
          
          # Generate summary report with GitHub Actions summary feature
          cat << EOF > $GITHUB_STEP_SUMMARY
          # Identity Resources Deployment Results
          
          **Resource Group:** ${{ env.RESOURCE_GROUP_NAME }}
          **Environment:** ${{ env.ENVIRONMENT }}
          **Region:** ${{ env.LOCATION }}
          **Date/Time UTC:** $(date -u +"%Y-%m-%d %H:%M:%S")
          
          ## Deployed Resources Status
          
          | Resource Type | Status |
          |--------------|--------|
          | Virtual Network | $(az network vnet show --resource-group ${{ env.RESOURCE_GROUP_NAME }} --name "vnet-identity" &>/dev/null && echo "✅ Deployed" || echo "❌ Missing") |
          | Key Vault | $(az keyvault list --resource-group ${{ env.RESOURCE_GROUP_NAME }} --query "[].name" -o tsv &>/dev/null && echo "✅ Deployed" || echo "❌ Missing") |
          | Managed Identities | $(az identity list --resource-group ${{ env.RESOURCE_GROUP_NAME }} --query "[].name" -o tsv &>/dev/null && echo "✅ Deployed" || echo "❌ Missing") |
          | Azure AD Domain Services | $([ "${{ env.DEPLOY_AADDS }}" == "true" ] && (az resource list --resource-group ${{ env.RESOURCE_GROUP_NAME }} --resource-type "Microsoft.AAD/domainServices" --query "[].name" -o tsv &>/dev/null && echo "✅ Deploying" || echo "❓ In progress") || echo "⚪ Not Requested") |
          
          ## Next Steps for Cloud-Only Identity Environment
          
          1. **Network Configuration**
             - Ensure all spoke networks are peered with the identity network
          
          2. **Azure AD Domain Services**
             - Complete domain configuration in Azure portal
             - Set up administrative users and groups
          
          3. **Key Vault Access**
             - Grant appropriate access to applications and users
          
          4. **Managed Identities**
             - Assign appropriate RBAC roles to managed identities
          
          This deployment summary generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF